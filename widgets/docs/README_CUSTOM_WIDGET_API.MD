# Custom Widget API
The Custom Widget API is a JavaScript API that can be used to create your own widget type. This API enables you to code a custom widget using DOM and SVG manipulation.

# Third pary libraries
The following third party libraries are available in the global name space and can be used inside a custom widget:

| Variable name | Library | Version |
|:--|:--|:-|
| d3 | [d3.js](https://d3js.org/) | 3.5.x |
| $ | [jQuery](http://jquery.com/) | 3.2.x |
| _ | [lodash](https://lodash.com/) | 3.10.x |

The [AngularJS $http](https://docs.angularjs.org/api/ng/service/$http) (Version 1.6.x) service is passed to the widget as part of its context. See below for details.

Additional libraries needed by a custom widget can be loaded using the **jsLoadService** described below.

# Accessing the API
You can access the API by accessing the **bvdPluginManager** global object directly. In BVD, this service object is assigned in the scope of window (window.bvdPluginManager), and is therefore made effectively global.
```javascript
window.bvdPluginManager.registerWidget({...}) // access from window's scope
bvdPluginManager.registerWidget({...}) // access it directly
```

# **bvdPluginManager** API
As mentioned in the previous section, in order to create a plugin, you have to access the **bvdPluginManager** API. This API only exposes one method:

**registerWidget**
- _Functionality_:  This method will create and register a custom widget according to the widget configuration object that you provide. This method only supports one parameter of the type JavaScript object { ... } (see _Params_ section).
- _Params_: Widget configuration object, a plain object that contains a set of supported configuration properties as listed below:

| Property      | Type         | Default value  | Description  |
|:------------- |:-------------|:-------------|:-------------|
| id            | object | - | ID of the widget. It must be the same as the value of the opr_item_type Visio property and the JavaScript file name of this custom widget |
| displayName   | string | - | Name as it appears in dashboard editor UI |
| init          | function | - | Callback function to initialize the widget with context that is passed back by BVD. This function is where you do most of your custom widget coding. More detail about this function is provided in the (_Init Plugin Callback_) section.|
| customProperty    | object | - | Array of objects that will be used to render the [Custom Widget Configuration UI](./README_CUSTOM_WIDGET_TEMPLATE.MD) |
| hasData           | boolean | true | Value true indicates that widget has a data field (see [Custom Widget Configuration UI Documentation](./README_CUSTOM_WIDGET_TEMPLATE.MD)) |
| isMultiselectDataField | boolean | false | Value true indicates that the user can select multiple data fields in the widget configuration UI (multi select input field will be shown) if hasData is true. Otherwise only one data field can get selected. |
| hasDataChannel    | boolean | true | Value true indicates that widget has a data channel (see [Custom Widget Configuration UI Documentation](./README_CUSTOM_WIDGET_TEMPLATE.MD)) |

Below is an example of the widget configuration file:
```javascript
    {
        id: 'pumping_circle',
        displayName: 'The Pumping Circle',
        init: function(ctx) {
            // widget implementation (see 'Init Plugin Callback' section below)
        },
        customProperty: [{
          id: 'bvd_range',
          label: 'Range',
          type: 'number',
          default: 100
        }, {
          id: 'opr_coloring_rule',
          label: 'Coloring Rule',
          type: 'text'
        }],
        hasData: true,
        hasDataChannel: true
    }
```

### Init Plugin Callback
As briefly mentioned in the previous section, this init callback function is the place where you do all of the coding for your custom widget. This function will be executed by the BVD UI when it loads the widget (e.g. when opening a dashboard in a browser). The init function receives a context object as a parameter, which has a set of properties as defined below:

| Property      | Type         | Description  |
|:------------- |:-------------|:-------------|
| parentGroup   | d3.js object | The parent SVG group of the shapes generated by Visio |
| svgGroup      | d3.js object | An empty SVG group element to attach your own elements (DOM located one level inside the parent group) |
| placeHolder   | array of d3.js object | List of placeholder shapes generated by Visio |
| dataField     | string | The name of the data field containing the values for this widget |
| bbox          | object | The computed [bounding box](https://developer.mozilla.org/en-US/docs/Web/API/SVGGraphicsElement) of the placeholder (x, y, width, height) |
| jsLoadService | function |Service to load external JavaScript files |
| getStatusColor | function | Get the calculated status color |
| $http         | object | [AngularJS $http](https://docs.angularjs.org/api/ng/service/$http) service, which can be used by the widget to get additional data from outside BVD |
| onChange      | function | Widget data change registration function |
| onInit        | function | Widget initial data function (data from cache) |
| getProperty   | function | Get value of widget's property |
| addAdminNotification | function | Notify users of problems with the widget |
| getChannelProperties| function | Gets additional information for this data channel |

**dataField** property
  - *Functionality*: Contains the name of the property of the data channel that has been selected by the user in the widget configuration to hold the value for this widget. If isMultiselectDataField is true, it will contain all selected data fields seperated by a semi-colon.

**getStatusColor** function
  - *Functionality*: Get the calculated status color based on the last received value. See  **opr_coloring_rule** in the _Special Properties_ section of the [Custom Widget Configuration UI Documentation](./README_CUSTOM_WIDGET_TEMPLATE.MD)

**jsLoadService** function
  - *Functionality*: A service which loads external JavaScript files asynchronously. If you use methods from this external JavaScript file in **onChange** or **onInit**, you must execute **onChange** or **onInit** after the promise of **jsLoadService** is resolved.
  - *Params*:
    - **string** location/address of the JavaScript file
  - *Return*:
    - promise object
      ```javascript
        ctx.jsLoadService.loadScript(
            'http://www.example.net/js/great_library.min.js'
        ).then(function success() {
            // do something (e.g. execute onInit or onChange)
        }, function failure() {
            // do something
        });
      ```

**onChange** callback function
  - *Functionality*: Function to register an event when the widget receives a data channel update
  - *Params*:
    - **object**, plain object, which contains these properties:
        - channel: channel name (optional)
        - callback: the change handler (will be called with the data received from the BVD server)
          ```javascript
            ctx.onChange({
                channel: 'myChannel',
                callback: function(dataUpdateEnvelope) {
                    if (dataUpdateEnvelope && dataUpdateEnvelope.data) {
                        // update displayed date with content of dataUpdateEnvelope.data
                      }
                }
            });
          ```

**onInit** callback function
  - *Functionality*: Function to get the initial data to be displayed by this widget
  - *Params*:
    - **object**, plain object, which contains these properties:
        - channel: channel name (optional)
        - itemCount: number of items from cache (max 9.999.999) or timestamp (Unix time ms). Using a timestamp will return all data from that time until now.
        - callback: the init handler (will be called with the data received from the BVD server)
          ```javascript
              ctx.onInit({
                channel: 'myChannel',
                itemCount: 1,
                callback: function(envelopeArray) {
                  if (Array.isArray(envelopeArray) && envelopeArray.length) {
                    // display initial data inside widget
                  }
                }
              });
          ```


**getProperty** function
  - *Functionality*: Get value of widget's property, which is defined in the 'customProperty' object of the widget configuration (see **widget configuration object** section above)
  - *Params*:
    - **string** of property name
  - *Return*:
    - object of property value
      ```javascript
          var range = ctx.getProperty('bvd_range');
      ```

**addAdminNotification** function
  - *Functionality*: Notify the current user of problems with the widget. Users with administrative rights will see these notifications displayed left of their user name.
  - *Params*:
    - **object**, plain object, which contains these properties:
        - severity: **string** one of 'info', 'warning', 'error'
        - title: **string** the title of this notification
        - text: **string** the notification text
  - *Return*: none

**getChannelProperties** function
  - *Functionality*: Gets additional information for the selected data channel
  - *Params*: none
  - *Return*: object, which contains these properties:
    - isRealtime: **boolean** If false, this data channel does not get updated and contains historic data only. Widgets can skip updating themselves after the initial data is received.

### Put it together
After you are done creating custom widget code, you need to put it onto the BVD server to be able to use it. The directory to place custom widget code in is located in *<config nfs share>/bvd/var/bvd/widgets*. The file name must match the widget configuration ID: ***<widget_configuration_id>.js***. When you open a dashboard in BVD which contains this custom widget, its JS file will get loaded from this directory. The custom widget code will then be executed, and the new custom widget will be registered in BVD.

Below is the example of how you can use the ***bvdPluginManager.registerWidget({})*** with your widget configuration file. This example will create a custom widget called ***pumping circle***.
```javascript
'use strict';

/**
 * The pumping circle widget
 * This widget shows a circle, that changes its radius,
 * based on the data coming through the channel
 */

bvdPluginManager.registerWidget({
  id: 'pumping_circle',
  displayName: 'The Pumping Circle',

  init: function(ctx) {
    const circleGroup = ctx.svgGroup,
      range = ctx.getProperty('bvd_range') || 100;

    console.log('range = ' + range);

    /* hide the placeholder */
    ctx.placeHolder.attr('style', 'visibility: hidden;');

    const circle = circleGroup
      .attr('transform', 'translate(' + ((ctx.bbox.x + ctx.bbox.width / 2)) + ',' + (ctx.bbox.y + ctx.bbox.height / 2) + ')')
      .append('circle')
      .attr('r', ctx.bbox.width / 4)
      .attr('cx', 0)
      .attr('cy', 0);

    const pumpCircle = function(envelope) {
      if (!envelope || !envelope.data) {
        return;
      }

      const currentColor = circle.attr('fill'),
        msg = envelope.data,
        radius = msg[ctx.dataField] / range * ctx.bbox.width / 2;

      circle.transition()
        .duration(300)
        .attr('r', radius)
        .attr('fill', ctx.getStatusColor() || currentColor);
    };

    /* get initial state of this widget*/
    ctx.onInit({
      itemCount: 1,
      callback: function(envelopeArray) {
        if (envelopeArray && envelopeArray.length > 0) {
          pumpCircle(envelopeArray[0]);
        }
      }
    });

    /* subscribe to changes */
    ctx.onChange({
      callback: pumpCircle
    });
  },

  customProperty: [{
    id: 'bvd_range',
    label: 'Range',
    type: 'number',
    default: 100
  }, {
    id: 'opr_coloring_rule',
    label: 'Coloring Rule',
    type: 'text'
  }]
});
```
